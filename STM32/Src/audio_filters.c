#include "audio_filters.h"
#include "stm32h7xx_hal.h"
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <math.h>
#include "arm_math.h"
#include "functions.h"
#include "wm8731.h"
#include "settings.h"
#include "noise_reduction.h"
#include "trx_manager.h"

arm_fir_instance_f32 FIR_RX_Hilbert_I;
arm_fir_instance_f32 FIR_RX_Hilbert_Q;
arm_fir_instance_f32 FIR_TX_Hilbert_I;
arm_fir_instance_f32 FIR_TX_Hilbert_Q;
arm_iir_lattice_instance_f32 IIR_LPF_I;
arm_iir_lattice_instance_f32 IIR_LPF_Q;
arm_iir_lattice_instance_f32 IIR_HPF_I;
arm_iir_lattice_instance_f32 IIR_HPF_Q;
arm_iir_lattice_instance_f32 IIR_Squelch_HPF;

//states
static float32_t Fir_Rx_Hilbert_State_I[FIR_RX_HILBERT_STATE_SIZE];
static float32_t Fir_Rx_Hilbert_State_Q[FIR_RX_HILBERT_STATE_SIZE];
static float32_t Fir_Tx_Hilbert_State_I[FIR_TX_HILBERT_STATE_SIZE];
static float32_t Fir_Tx_Hilbert_State_Q[FIR_TX_HILBERT_STATE_SIZE];
static float32_t IIR_LPF_I_State[IIR_LPF_Taps_STATE_SIZE];
static float32_t IIR_LPF_Q_State[IIR_LPF_Taps_STATE_SIZE];
static float32_t IIR_HPF_I_State[IIR_HPF_Taps_STATE_SIZE];
static float32_t IIR_HPF_Q_State[IIR_HPF_Taps_STATE_SIZE];
static float32_t IIR_HPF_SQL_State[IIR_HPF_SQL_STATE_SIZE];

//notch filter
volatile bool NeedReinitNotch = false;
static float32_t NOTCH_Coeffs[NOTCH_COEFF_IN_STAGE * NOTCH_STAGES] = {0};
static float32_t NOTCH_State[2 * NOTCH_STAGES];
static float32_t NOTCH_State_FFT_I[2 * NOTCH_STAGES];
static float32_t NOTCH_State_FFT_Q[2 * NOTCH_STAGES];
arm_biquad_cascade_df2T_instance_f32 NOTCH_FILTER = {NOTCH_STAGES, NOTCH_State, NOTCH_Coeffs};
arm_biquad_cascade_df2T_instance_f32 NOTCH_FILTER_FFT_I = {NOTCH_STAGES, NOTCH_State_FFT_I, NOTCH_Coeffs};
arm_biquad_cascade_df2T_instance_f32 NOTCH_FILTER_FFT_Q = {NOTCH_STAGES, NOTCH_State_FFT_Q, NOTCH_Coeffs};

//with (+90 q / -0 i) degrees phase added, narrow 3.6k
static const float32_t FIR_HILB_RX_I_coeffs[IQ_TX_HILBERT_TAPS] = {-0.000181752008817777,-0.00019812444299558,-0.000173915580313638,-0.000106975730010085,-0.0000174463735378,0.000049667546759971,0.000032561004630231,-0.000127681493947272,-0.000459708207577463,-0.000935771201527816,-0.00145865712043841,-0.00187227346724911,-0.00200036401889901,-0.00170780689629204,-0.000967958368014592,0.000088289293095689,0.001166623215145986,0.001862531622450524,0.001771946721352388,0.000635741675713185,-0.00152451719575799,-0.00433057882661493,-0.00707443210838268,-0.00886614749018614,-0.00888315684570901,-0.00666207782636225,-0.0023460199801576,0.003204723474564544,0.008506335530971061,0.011765956147501436,0.011367103182967093,0.006413424630698947,-0.00282047953175066,-0.0146812039524101,-0.0262751422843746,-0.0339730971952901,-0.0341994964523126,-0.0243347165617545,-0.00350726050818481,0.026942155121425213,0.063476622132557281,0.100898465799951861,0.133312097666693830,0.155307720769003010,0.163093615613067344,0.155307720769004343,0.133312097666696161,0.100898465799954873,0.063476622132560459,0.026942155121428071,-0.00350726050818265,-0.0243347165617533,-0.0341994964523123,-0.0339730971952905,-0.0262751422843754,-0.0146812039524111,-0.00282047953175152,0.006413424630698421,0.011367103182966964,0.011765956147501661,0.008506335530971517,0.003204723474565072,-0.00234601998015715,-0.00666207782636198,-0.00888315684570896,-0.00886614749018627,-0.00707443210838294,-0.00433057882661522,-0.00152451719575822,0.000635741675713052,0.001771946721352369,0.001862531622450603,0.001166623215146122,0.000088289293095838,-0.00096795836801447,-0.00170780689629197,-0.002000364018899,-0.00187227346724914,-0.00145865712043846,-0.000935771201527874,-0.000459708207577509,-0.000127681493947298,0.000032561004630225,0.000049667546759980,-0.000017446373537785,-0.00010697573001007,-0.000173915580313629,-0.000198124442995578,-0.000181752};
static const float32_t FIR_HILB_RX_Q_coeffs[IQ_TX_HILBERT_TAPS] = {-0.000294806871446761,-0.000430038513938049,-0.00057577635651954,-0.000701452460068679,-0.000773483568490036,-0.000770724776536896,-0.000701666832263429,-0.000616113554803381,-0.000603644067469941,-0.00077404001429163,-0.00122090559459946,-0.00197736129120186,-0.00297920572331694,-0.00405321865749724,-0.00494407320037525,-0.00538239440020133,-0.00518124403535075,-0.00433349474961163,-0.00307403519977391,-0.00187345276484406,-0.00134566807456456,-0.00207838789258401,-0.00442514292801338,-0.00832115293523963,-0.0131925136715957,-0.0180131059057811,-0.0215266256625295,-0.0226003081681251,-0.0206265730133377,-0.0158556828219807,-0.00954049290906044,-0.00380949445236171,-0.00125158785236759,-0.00427935828129978,-0.0144137579244869,-0.0316779221618311,-0.0542839354303643,-0.0787391229290012,-0.100398818306822,-0.114375118099481,-0.116607805332378,-0.104844680649768,-0.0792835060106304,-0.0426990455969243,-1.802423033856850E-15,0.042699045596920997,0.079283506010627697,0.104844680649766375,0.116607805332377912,0.114375118099481379,0.100398818306823789,0.078739122929003105,0.054283935430366234,0.031677922161832718,0.014413757924488018,0.004279358281300266,0.001251587852367549,0.003809494452361318,0.009540492909059896,0.015855682821980240,0.020626573013337410,0.022600308168125034,0.021526625662529674,0.018013105905781469,0.013192513671596058,0.008321152935239943,0.004425142928013570,0.002078387892584060,0.001345668074564481,0.001873452764843904,0.003074035199773733,0.004333494749611476,0.005181244035350659,0.005382394400201308,0.004944073200375284,0.004053218657497318,0.002979205723317022,0.001977361291201922,0.001220905594599500,0.000774040014291644,0.000603644067469934,0.000616113554803364,0.000701666832263413,0.000770724776536887,0.000773483568490036,0.000701452460068687,0.000575776356519553,0.000430038513938061,0.000294806871446770};
	
//with (+45 q / -45 i) degrees phase added, 48000 sampling frequency Fc=1.50kHz, BW=2.70kHz Kaiser, Beta = 3.650, Raised Cosine 0.910
static const float32_t FIR_HILB_TX_I_coeffs[IQ_TX_HILBERT_TAPS] = {-0.000015911433738947, -0.000019959728028938, -0.000023891471599754, -0.000027119763124069, -0.000029087039705292, -0.000029431397715954, -0.000028148219961633, -0.000025702247123746, -0.000023048146401552, -0.000021532467002145, -0.000022675017711946, -0.000027858477628481, -0.000037984418906156, -0.000053173935947263, -0.000072594827015540, -0.000094480871554435, -0.000116372847662635, -0.000135561336982947, -0.000149658359810178, -0.000157181343994879, -0.000158011427902595, -0.000153597634188139, -0.000146821594676398, -0.000141508706977174, -0.000141657313079918, -0.000150538332814799, -0.000169872539761493, -0.000199303342326905, -0.000236339821701096, -0.000276850226155669, -0.000316055860965538, -0.000349836665758744, -0.000376046667777827, -0.000395483070998372, -0.000412180921252682, -0.000432823344456314, -0.000465251321301123, -0.000516291531622259, -0.000589344418113810, -0.000682329334357383, -0.000786618128311585, -0.000887471604155052, -0.000966224936321975, -0.001004084647738534, -0.000986971617519555, -0.000910465431454767, -0.000783674244635495, -0.000630853460997997, -0.000489869695624849, -0.000407142410379079, -0.000429421385599579, -0.000593545407736026, -0.000916011846980452, -0.001384598358663629, -0.001954277926711752, -0.002549184202610570, -0.003071435226054831, -0.003416332297185353, -0.003492031457300130, -0.003240513223388775, -0.002655839887826624, -0.001795531271501309, -0.000781549566761797, 0.000211143419483594, 0.000978377875720550, 0.001320403087257693, 0.001080515967568864, 0.000182121345956079, -0.001343074868529297, -0.003342478753804935, -0.005550446581697207, -0.007618265957299014, -0.009164142003551838, -0.009837061742258062, -0.009385008993095094, -0.007715887072085315, -0.004939218878809190, -0.001378502462245723, 0.002452076537338900, 0.005907488065309155, 0.008302997095508243, 0.009025375745234239, 0.007648260210940124, 0.004033210841998318, -0.001601654938770521, -0.008660246045580289, -0.016203010335164171, -0.023038057426319945, -0.027860750884303231, -0.029425395934213904, -0.026726377512887117, -0.019162929429234910, -0.006662334542242190, 0.010259113968032065, 0.030510126124987710, 0.052515877605683242, 0.074378297568183149, 0.094086304242110563, 0.109749301278724468, 0.119823145137080742, 0.123298109645664233, 0.119823145137071957, 0.109749301278707773, 0.094086304242087637, 0.074378297568156199, 0.052515877605654772, 0.030510126124960246, 0.010259113968007870, -0.006662334542261386, -0.019162929429248053, -0.026726377512893910, -0.029425395934214775, -0.027860750884299197, -0.023038057426312451, -0.016203010335154873, -0.008660246045570802, -0.001601654938762230, 0.004033210842004407, 0.007648260210943465, 0.009025375745234765, 0.008302997095506299, 0.005907488065305405, 0.002452076537334174, -0.001378502462250567, -0.004939218878813399, -0.007715887072088339, -0.009385008993096640, -0.009837061742258109, -0.009164142003550596, -0.007618265957296863, -0.005550446581694617, -0.003342478753802375, -0.001343074868527162, 0.000182121345957515, 0.001080515967569481, 0.001320403087257519, 0.000978377875719736, 0.000211143419482372, -0.000781549566763161, -0.001795531271502565, -0.002655839887827574, -0.003240513223389301, -0.003492031457300196, -0.003416332297185003, -0.003071435226054171, -0.002549184202609736, -0.001954277926710889, -0.001384598358662863, -0.000916011846979873, -0.000593545407735683, -0.000429421385599475, -0.000407142410379183, -0.000489869695625105, -0.000630853460998336, -0.000783674244635851, -0.000910465431455086, -0.000986971617519803, -0.001004084647738694, -0.000966224936322048, -0.000887471604155053, -0.000786618128311534, -0.000682329334357303, -0.000589344418113718, -0.000516291531622168, -0.000465251321301040, -0.000432823344456239, -0.000412180921252613, -0.000395483070998306, -0.000376046667777760, -0.000349836665758677, -0.000316055860965474, -0.000276850226155611, -0.000236339821701050, -0.000199303342326874, -0.000169872539761481, -0.000150538332814806, -0.000141657313079940, -0.000141508706977206, -0.000146821594676434, -0.000153597634188172, -0.000158011427902620, -0.000157181343994892, -0.000149658359810178, -0.000135561336982934, -0.000116372847662614, -0.000094480871554409, -0.000072594827015514, -0.000053173935947240, -0.000037984418906137, -0.000027858477628469, -0.000022675017711940, -0.000021532467002142, -0.000023048146401550, -0.000025702247123743, -0.000028148219961627, -0.000029431397715943, -0.000029087039705276, -0.000027119763124050, -0.000023891471599733, -0.000019959728028917, -0.000015911433738929};
static const float32_t FIR_HILB_TX_Q_coeffs[IQ_TX_HILBERT_TAPS] = {-0.000055876484573473, -0.000064501669527415, -0.000074738701316321, -0.000086507654429771, -0.000099410855699246, -0.000112742030021933, -0.000125581860328626, -0.000136976384505566, -0.000146171471747199, -0.000152855683517751, -0.000157351204077214, -0.000160693204323070, -0.000164554344882989, -0.000171001789764558, -0.000182113756522494, -0.000199522659221598, -0.000223982104007250, -0.000255065964662709, -0.000291093444701605, -0.000329333837166658, -0.000366484543520879, -0.000399347771170467, -0.000425571116339335, -0.000444281412941937, -0.000456442686257327, -0.000464813293654387, -0.000473459903203533, -0.000486891982756433, -0.000508986765583088, -0.000541954254458334, -0.000585620149319337, -0.000637266013271176, -0.000692159225019129, -0.000744745974185545, -0.000790300256973267, -0.000826662663506291, -0.000855608799816551, -0.000883393930312482, -0.000920144557182625, -0.000977999833391699, -0.001068208413135301, -0.001197698143396605, -0.001365882230232392, -0.001562573853813371, -0.001767799237590146, -0.001954010129822268, -0.002090729412517879, -0.002151093704598354, -0.002119197166650733, -0.001996721724352054, -0.001807182145055243, -0.001596303598977302, -0.001427605606562385, -0.001373133139886880, -0.001500318939184498, -0.001856985786393334, -0.002457280182694243, -0.003271661399515204, -0.004223805794000835, -0.005196381265502662, -0.006046183103054665, -0.006627310796927153, -0.006819219662039622, -0.006554969302166284, -0.005844167767895242, -0.004785243876864911, -0.003562886684106115, -0.002428691218878755, -0.001665958674417137, -0.001542756544570849, -0.002260180366086176, -0.003904692125323062, -0.006413957060137492, -0.009564477743523059, -0.012986526898586098, -0.016207713154723136, -0.018721568815726210, -0.020072626005615220, -0.019945430948836697, -0.018242650197742859, -0.015137438929630096, -0.011087811480348275, -0.006805694582534307, -0.003180041098991087, -0.001160864894184417, -0.001618136646873710, -0.005194938168183790, -0.012177070502025733, -0.022400779394307693, -0.035216238922248289, -0.049517325350430505, -0.063838956132037980, -0.076513206133968448, -0.085866090480225241, -0.090429824178616405, -0.089141744773038101, -0.081501626274434108, -0.067663896323307105, -0.048449702280469985, -0.025274673539499328, 16.41584600088100E-15, 0.025274673539530806, 0.048449702280497546, 0.067663896323328629, 0.081501626274448152, 0.089141744773044040, 0.090429824178614490, 0.085866090480216414, 0.076513206133954376, 0.063838956132020688, 0.049517325350412138, 0.035216238922230865, 0.022400779394292886, 0.012177070502014685, 0.005194938168177043, 0.001618136646871193, 0.001160864894185542, 0.003180041098994882, 0.006805694582539598, 0.011087811480353871, 0.015137438929634959, 0.018242650197746225, 0.019945430948838137, 0.020072626005614679, 0.018721568815723948, 0.016207713154719635, 0.012986526898581976, 0.009564477743518948, 0.006413957060133944, 0.003904692125320466, 0.002260180366084725, 0.001542756544570538, 0.001665958674417785, 0.002428691218880064, 0.003562886684107731, 0.004785243876866489, 0.005844167767896496, 0.006554969302167027, 0.006819219662039779, 0.006627310796926756, 0.006046183103053836, 0.005196381265501569, 0.004223805793999667, 0.003271661399514136, 0.002457280182693402, 0.001856985786392793, 0.001500318939184273, 0.001373133139886934, 0.001427605606562642, 0.001596303598977673, 0.001807182145055637, 0.001996721724352394, 0.002119197166650973, 0.002151093704598469, 0.002090729412517876, 0.001954010129822170, 0.001767799237589989, 0.001562573853813192, 0.001365882230232221, 0.001197698143396462, 0.001068208413135197, 0.000977999833391630, 0.000920144557182582, 0.000883393930312452, 0.000855608799816521, 0.000826662663506252, 0.000790300256973217, 0.000744745974185486, 0.000692159225019068, 0.000637266013271121, 0.000585620149319296, 0.000541954254458312, 0.000508986765583088, 0.000486891982756452, 0.000473459903203566, 0.000464813293654426, 0.000456442686257364, 0.000444281412941965, 0.000425571116339349, 0.000399347771170465, 0.000366484543520863, 0.000329333837166631, 0.000291093444701573, 0.000255065964662676, 0.000223982104007221, 0.000199522659221575, 0.000182113756522479, 0.000171001789764551, 0.000164554344882987, 0.000160693204323071, 0.000157351204077214, 0.000152855683517748, 0.000146171471747192, 0.000136976384505555, 0.000125581860328611, 0.000112742030021918, 0.000099410855699231, 0.000086507654429759, 0.000074738701316315, 0.000064501669527414, 0.000055876484573478};

static const IIR_LATTICE_FILTER IIR_Lattice_Filters[IIR_FILTERS_COUNT] = (const IIR_LATTICE_FILTER[]){
	//IIR RX/TX IIR Highpass Fs=48000 Apass=1 Astop=120 // coefficients converted to ARMA in reverse order by MATLAB
	{
		.width = 60,
		.type = IIR_LATTICE_HPF,
		.stages = 5,
		.coeffsK_lattice = (float32_t[]){-0.9781281839347,0.9999154490363,-0.9999810493194,0.9999899830477,-0.9999909919434},
		.coeffsV_ladder = (float32_t[]){-0.9890036319118,0.02187130374332,0.0002381377186271,-1.793628179314e-08,-2.163376144892e-09,9.847678228425e-14},
	},
	{
		.width = 100,
		.type = IIR_LATTICE_HPF,
		.stages = 6,
		.coeffsK_lattice = (float32_t[]){0.9563661875051,-0.9996595470581,0.9999262586807,-0.9999636869682,0.9999752137272,-0.9999748631985},
		.coeffsV_ladder = (float32_t[]){0.9779397668083,-0.04362981032435,-0.0009435396408364,2.809543104831e-07,3.499154743736e-08,-6.204814440025e-12,-6.213918268827e-13},
	},
	{
		.width = 200,
		.type = IIR_LATTICE_HPF,
		.stages = 6,
		.coeffsK_lattice = (float32_t[]){0.9146337760682,-0.9986390650223,0.9997049389392,-0.9998550144328,0.9999002634644,-0.9998997406296},
		.coeffsV_ladder = (float32_t[]){0.9563648760114,-0.08533490808587,-0.003574788463718,4.328009545418e-06,5.461078487201e-07,-3.928795067054e-10,-3.991140751225e-11},
	},
	{
		.width = 300,
		.type = IIR_LATTICE_HPF,
		.stages = 7,
		.coeffsK_lattice = (float32_t[]){-0.8549835162318,0.995838199124,-0.9991124666877,0.9995794716698,-0.9997296224307,0.9997880158959,-0.9997725212127},
		.coeffsV_ladder = (float32_t[]){-0.9246531870014,0.1448562839769,0.01013942864446,-3.798068345873e-05,-4.9194452032e-06,1.026578999586e-08,1.185111564439e-09,-1.902034085788e-12},
	},
	{
		.width = 400,
		.type = IIR_LATTICE_HPF,
		.stages = 7,
		.coeffsK_lattice = (float32_t[]){-0.8125098833439,0.9927017320968,-0.99843586412,0.9992573174358,-0.9995211553851,0.9996235697847,-0.9995951889869},
		.coeffsV_ladder = (float32_t[]){-0.9013933011422,0.1871256062821,0.01668612167291,-0.0001123981989259,-1.471745833115e-05,5.465184216291e-08,6.284545328583e-09,-1.797872961617e-11},
	},
	{
		.width = 500,
		.type = IIR_LATTICE_HPF,
		.stages = 8,
		.coeffsK_lattice = (float32_t[]){0.7445864438888,-0.985402065113,0.9968840386634,-0.998551601584,0.9990957362136,-0.9993294607488,0.9994302330011,-0.999360978271},
		.coeffsV_ladder = (float32_t[]){0.862894225203,-0.254426502082,-0.03004923553443,0.0004187329835759,5.590628282448e-05,-4.046024955073e-07,-4.801554709388e-08,2.894875450465e-10,2.31238361792e-11},
	},
	//used for the FM noise squelch
	{
		.width = 15000,
		.type = IIR_LATTICE_HPF,
		.stages = 41,
		.coeffsK_lattice = (float32_t[]){-1.345485349007e-08,2.389521171261e-07,-2.203228037228e-06,1.396378348744e-05,-6.803148109211e-05,0.0002703486206341,-0.0009083849294174,0.002642193228705,-0.006760090043425,0.0153815467982,-0.03135535236959,0.05754728850407,-0.09542794958997,0.1436438570118,-0.1974692863579,0.2515002576911,-0.2984398172954,0.3434432859449,-0.3639504627245,0.4217449893123,-0.3698259033422,0.5325776467982,-0.278822850002,0.6922522654791,-0.1181431474058,0.8237737592598,0.0168256384061,0.8983278551082,0.1079170008164,0.9404745672184,0.1743068291895,0.9659604545294,0.2266355105569,0.9816787285593,0.2697110414111,0.9911969919091,0.3061643717078,0.9966164004758,0.3376322363232,0.9992608750274,0.3652053065839},
		.coeffsV_ladder = (float32_t[]){-0.0001159950580424,0.001030009903626,-0.004923949586818,0.01646772655047,-0.04251197897033,0.08879941261464,-0.1535265801861,0.2210586114129,-0.2621501554828,0.2456926941686,-0.1593867051513,0.02670094630923,0.09611149895478,-0.149214922352,0.1097574637616,-0.01177379980503,-0.07709532532793,0.1053325317102,-0.0691793592414,0.003727140487882,0.04700785416007,-0.06378931488669,0.04382295541029,-0.007044101910083,-0.01352654127794,0.03174315980228,-0.01765966722063,0.004478047696708,0.000433396700803,-0.006950600731948,0.002397720626181,-0.0009301901913483,0.0001550517959346,0.0004913555761008,-9.185672549061e-05,5.573694750505e-05,-7.04186722339e-06,-8.625298716904e-06,6.212029035439e-07,-6.426850108409e-07,2.541664986127e-08,1.481329626592e-08},
	},
	{
		.width = 20000,
		.type = IIR_LATTICE_HPF,
		.stages = 22,
		.coeffsK_lattice = (float32_t[]){0.000149883237581,0.002592226125158,0.01996128806124,0.08904859134725,0.2507519585442,0.4695547755594,0.6478554677952,0.7552393036621,0.8172197646105,0.8559449156443,0.882219082308,0.9006621899592,0.9152891992076,0.9233746133099,0.9381067021279,0.9281879903561,0.9650996658952,0.9075411260292,0.9898279096253,0.8783422414901,0.9985402732802,0.8645285087017},
		.coeffsV_ladder = (float32_t[]){5.392371464855e-06,-2.963559305979e-05,0.0001056594281069,-0.0002988372022476,0.0007237688157042,-0.001548374788374,0.002892090006671,-0.00454359447201,0.005926560175923,-0.006471025251894,0.005965068716627,-0.004647498928921,0.003048009472353,-0.001657468380478,0.0007265977508362,-0.0002429310218478,4.650481598778e-05,-2.873331845603e-06,-6.242912728666e-06,1.046791889704e-06,-2.821227924218e-07,1.809458202695e-08,9.046463092308e-09},
	},
	//IIR RX/TX IIR Lowpass Fs=48000 Apass=1 Astop=120 // coefficients converted to ARMA in reverse order by MATLAB
	{
		.width = 300,
		.type = IIR_LATTICE_LPF,
		.stages = 8,
		.coeffsK_lattice = (float32_t[]){0.8013141336369,-0.9917632596714,0.9982730035379,-0.9992103143401,0.9995176167882,-0.9996494302193,0.9997179165634,-0.9996456923676},
		.coeffsV_ladder = (float32_t[]){5.663962793654e-07,2.135877318152e-07,3.560664622899e-07,6.489174699543e-08,3.581851784767e-08,3.137842748056e-09,1.118525121196e-09,4.112967349243e-11,1.077536191655e-11},
	},
	{
		.width = 500,
		.type = IIR_LATTICE_LPF,
		.stages = 10,
		.coeffsK_lattice = (float32_t[]){0.6322642156221,-0.9655370520103,0.9926965581112,-0.9967625874651,0.9980966988227,-0.9986945695629,0.9990007982649,-0.9991885106242,0.9993290082953,-0.9989229074493},
		.coeffsV_ladder = (float32_t[]){4.335641032866e-07,3.112634831561e-07,5.557748546445e-07,2.011643608527e-07,1.239213736655e-07,2.342725621661e-08,9.186968224044e-09,9.567407291419e-10,2.698223504301e-10,1.224742745693e-11,2.713346942202e-12},
	},
	{
		.width = 700,
		.type = IIR_LATTICE_LPF,
		.stages = 11,
		.coeffsK_lattice = (float32_t[]){-0.4915254875487,0.9201171843809,-0.9823675668542,0.9923150037132,-0.9955409162962,0.996989200457,-0.9977453716593,0.9982506766759,-0.9983868712985,0.9988346366719,-0.9976503765141},
		.coeffsV_ladder = (float32_t[]){7.488520088132e-07,1.502664790918e-06,1.2901318792e-06,1.269713623819e-06,4.736940584448e-07,2.501779785671e-07,5.361210844726e-08,1.916213122899e-08,2.340631782551e-09,6.150332311547e-10,3.272971908654e-11,6.885946816275e-12},
	},
	{
		.width = 1000,
		.type = IIR_LATTICE_LPF,
		.stages = 13,
		.coeffsK_lattice = (float32_t[]){-0.298512455839,0.7915001557088,-0.9476036391542,0.9778944176183,-0.9874333729374,0.9916900386528,-0.9939551372433,0.9952879545358,-0.9961466769269,0.9967351939709,-0.9967856371127,0.9982761668579,-0.9942029367652},
		.coeffsV_ladder = (float32_t[]){8.320843786037e-07,1.785530519145e-06,2.450917387052e-06,2.997131981842e-06,1.860897694868e-06,1.189660183575e-06,4.416571420933e-07,1.886044826209e-07,4.449856720259e-08,1.371466843575e-08,1.920729195322e-09,4.479123083583e-10,2.645405049294e-11,4.719920118516e-12},
	},
	{
		.width = 1400,
		.type = IIR_LATTICE_LPF,
		.stages = 15,
		.coeffsK_lattice = (float32_t[]){-0.1378696803402,0.5557431363627,-0.8525369049189,0.9394579619967,-0.9664805162565,0.9782108684713,-0.9844120991512,0.9880852724877,-0.9904276296631,0.9920593966929,-0.9928212148083,0.9943800670431,-0.9930341560683,0.9980766890119,-0.9862125550541},
		.coeffsV_ladder = (float32_t[]){1.243476166962e-06,3.036516076011e-06,5.794024316416e-06,9.114869211652e-06,8.751823669701e-06,7.180447224538e-06,4.159407398583e-06,2.253949561173e-06,8.714145836306e-07,3.364563288322e-07,8.680834031314e-08,2.458236705237e-08,3.826772685815e-09,7.983552828973e-10,4.745799521087e-11,5.574170197186e-12},
	},
	{
		.width = 1600,
		.type = IIR_LATTICE_LPF,
		.stages = 15,
		.coeffsK_lattice = (float32_t[]){-0.103560250966,0.4734149098944,-0.8046112749573,0.9194721206832,-0.9558074089393,0.9713642460722,-0.9795426607353,0.9843765272614,-0.9874522952018,0.9895462065557,-0.990834204773,0.9925628792227,-0.9905389530442,0.9974982686764,-0.982088416945},
		.coeffsV_ladder = (float32_t[]){1.594661989122e-06,4.300432050986e-06,9.150947046409e-06,1.57457065957e-05,1.754200285758e-05,1.589921037641e-05,1.061474977047e-05,6.295880747498e-06,2.80368552731e-06,1.169440307837e-06,3.485464689267e-07,1.043244842547e-07,1.872246891638e-08,3.969922628738e-09,2.849552519368e-10,2.750981128535e-11},
	},
	{
		.width = 1800,
		.type = IIR_LATTICE_LPF,
		.stages = 16,
		.coeffsK_lattice = (float32_t[]){0.06475129593473,-0.3546928101262,0.7145310295479,-0.8796454639216,0.9351633196992,-0.9584279975324,0.9705254666219,-0.9776516498878,0.9821976643822,-0.9852376493543,0.9874955912755,-0.9885401123447,0.9912943101072,-0.9869456470501,0.9976717949894,-0.9760194649374},
		.coeffsV_ladder = (float32_t[]){1.559287374865e-06,4.459524200542e-06,1.084351394269e-05,1.961030361147e-05,2.681408940979e-05,2.642798923741e-05,2.163540912849e-05,1.380831057883e-05,7.742175877094e-06,3.398020080172e-06,1.36019038419e-06,4.044134872209e-07,1.15661775192e-07,2.056018975877e-08,3.955738212225e-09,2.746604233079e-10,9.794268089692e-12},
	},
	{
		.width = 2100,
		.type = IIR_LATTICE_LPF,
		.stages = 17,
		.coeffsK_lattice = (float32_t[]){-0.03251987463501,0.2219661069531,-0.5675546797777,0.8032506951586,-0.8962417007604,0.9345684492791,-0.9540485738947,0.9654240175342,-0.9726530813325,0.9775371898963,-0.9808968271216,0.9836384890579,-0.9842556053127,0.9896719592495,-0.9794521898177,0.9978349128938,-0.9655997791098},
		.coeffsV_ladder = (float32_t[]){2.125323004746e-06,6.885923760742e-06,1.733263494922e-05,3.637394638825e-05,5.650782155615e-05,6.774593082093e-05,6.293389402976e-05,4.895231267586e-05,3.083586220306e-05,1.685562914336e-05,7.434755927672e-06,2.91000811913e-06,8.696413800007e-07,2.38217341381e-07,4.113049209277e-08,6.420726567408e-09,4.509990459025e-10,-4.208721922726e-11},
	},
	{
		.width = 2300,
		.type = IIR_LATTICE_LPF,
		.stages = 18,
		.coeffsK_lattice = (float32_t[]){0.01841721811619,-0.1463209218865,0.4472542544951,-0.7243756084671,0.8554982875236,-0.9103552756024,0.9376305658307,-0.9533854508565,0.9633622511947,-0.9700662090606,0.9748268492929,-0.9780610696321,0.9813851508153,-0.9805863074494,0.9891640051397,-0.9727763959829,0.9981270007125,-0.9576067645425},
		.coeffsV_ladder = (float32_t[]){1.937710800824e-06,6.794103051693e-06,1.830394506504e-05,4.040473995569e-05,7.145919097103e-05,9.529561909501e-05,0.0001017197938849,8.769301223435e-05,6.39567170064e-05,3.861626595892e-05,2.016931102113e-05,8.635655797763e-06,3.233401462281e-06,9.340564215575e-07,2.376730011204e-07,3.86091787477e-08,4.166816347935e-09,3.07707111876e-10,-9.043262744201e-11},
	},
	{
		.width = 2500,
		.type = IIR_LATTICE_LPF,
		.stages = 19,
		.coeffsK_lattice = (float32_t[]){-0.009978792054696,0.09132195352611,-0.3312391050856,0.6263658541486,-0.8014860072458,0.8790129407673,-0.9167750207935,0.9382448670522,-0.9517458830871,0.9608132359719,-0.9671542400869,0.9719066152497,-0.9748890719046,0.9791363493696,-0.9760353115129,0.9892810270232,-0.9646081281248,0.9983509042792,-0.9488920561362},
		.coeffsV_ladder = (float32_t[]){1.753168301118e-06,6.68742435526e-06,1.883619902576e-05,4.433496742921e-05,8.524989887087e-05,0.000128676621146,0.0001526625323994,0.000149064682736,0.0001206107865024,8.317823595941e-05,4.81667235456e-05,2.406260984793e-05,9.939111444777e-06,3.539231725369e-06,9.734032389431e-07,2.235505011875e-07,3.315935971166e-08,9.560094932218e-10,1.352586383757e-10,-1.283679255466e-10},
	},
	{
		.width = 2700,
		.type = IIR_LATTICE_LPF,
		.stages = 18,
		.coeffsK_lattice = (float32_t[]){0.008965624081138,-0.08385627975783,0.3125511547536,-0.6074509857038,0.7900217774095,-0.87208573917,0.9119449696755,-0.93451827936,0.9486844611498,-0.9581489924489,0.9648933555879,-0.969307724189,0.9743860367608,-0.9722607068205,0.9859785177109,-0.9603365223377,0.9977307098142,-0.9409641875565},
		.coeffsV_ladder = (float32_t[]){3.462945431292e-06,1.369318369495e-05,3.950464119843e-05,9.388265274167e-05,0.0001847036828473,0.0002822658222065,0.0003416771635736,0.0003344375496455,0.0002732716740969,0.0001856030901555,0.0001070938636694,5.100035347387e-05,2.058920169974e-05,6.485458114159e-06,1.664818586307e-06,2.813744297363e-07,1.214876329489e-08,1.212709635369e-09,-1.468444025814e-09},
	},
	{
		.width = 2900,
		.type = IIR_LATTICE_LPF,
		.stages = 19,
		.coeffsK_lattice = (float32_t[]){-0.004658747989782,0.04955914534882,-0.215955060389,0.4947403670692,-0.7176517479057,0.8303669103766,-0.8849346191158,0.9151953252444,-0.9339762097435,0.9465130841432,-0.9552260946823,0.9618206358714,-0.9656671546945,0.9722038351355,-0.9664254714471,0.9864930246407,-0.9501584150351,0.9980202587216,-0.9308666636951},
		.coeffsV_ladder = (float32_t[]){2.920896016655e-06,1.249243408657e-05,3.781906357233e-05,9.440236020026e-05,0.0001987343314601,0.0003377119774122,0.0004537413433261,0.0004969273715321,0.0004505734143218,0.0003446466673876,0.0002214550183074,0.0001208881752329,5.463014800855e-05,2.065967860364e-05,6.041569275713e-06,1.329936583132e-06,1.938744549662e-07,-1.901715575582e-08,-7.005477373162e-10,-1.493050537725e-09},
	},
	{
		.width = 3000,
		.type = IIR_LATTICE_LPF,
		.stages = 19,
		.coeffsK_lattice = (float32_t[]){-0.003805987075288,0.04198327148955,-0.1911616828073,0.4599869733315,-0.6925132964583,0.815584179615,-0.8754339586341,0.9083984239301,-0.9287697941692,0.9423452083667,-0.9517502710579,0.9589347024575,-0.9629078350168,0.9704328971274,-0.9631648544295,0.9861675491093,-0.9452877930903,0.9980161583084,-0.9256881348113},
		.coeffsV_ladder = (float32_t[]){3.792348790504e-06,1.638528467191e-05,4.987226073979e-05,0.0001249560174803,0.0002655831772942,0.0004596688749428,0.0006304744860253,0.0007036070517821,0.000649359717345,0.0005045701113265,0.0003289609933613,0.0001816636440269,8.28679535729e-05,3.143097043388e-05,9.167310151415e-06,1.942486175644e-06,2.72920934147e-07,-4.442366422413e-08,-1.971556355517e-09,-2.468889251473e-09},
	},
	{
		.width = 3200,
		.type = IIR_LATTICE_LPF,
		.stages = 19,
		.coeffsK_lattice = (float32_t[]){-0.002654378744009,0.03113104419019,-0.152623525422,0.3997285451756,-0.6449392395637,0.7869931502585,-0.8571990143222,0.8954259358769,-0.9188494135996,0.9343903569827,-0.9451374711179,0.9533090193347,-0.9579048117484,0.9662793085379,-0.9584535990163,0.9839973606147,-0.9384250654074,0.9976742421263,-0.9157808253751},
		.coeffsV_ladder = (float32_t[]){3.552978086738e-06,1.66643535989e-05,5.353764870769e-05,0.000139960670625,0.0003116172822232,0.0005727714632474,0.0008397246010835,0.0009986270260527,0.0009808245814834,0.0008078044836786,0.0005577711494832,0.0003242202018632,0.0001555825827748,6.12791172937e-05,1.853089312431e-05,3.869412049474e-06,5.165916347403e-07,-1.394948032898e-07,-8.794237530718e-09,-6.270985297502e-09},
	},
	{
		.width = 3400,
		.type = IIR_LATTICE_LPF,
		.stages = 19,
		.coeffsK_lattice = (float32_t[]){-0.001768017361043,0.02212228841423,-0.1171816535191,0.3360372401441,-0.588013086948,0.7513825532247,-0.8347379021216,0.8796627548692,-0.9068921374544,0.9248752831718,-0.9372145458529,0.9467946203438,-0.9515593497791,0.9624484326443,-0.9507772789383,0.9834065983975,-0.9272731705366,0.9976662637338,-0.9042303666097},
		.coeffsV_ladder = (float32_t[]){5.659318080981e-06,2.702241419109e-05,8.760920482944e-05,0.0002301919778049,0.0005177003349417,0.0009767635315612,0.001482599213879,0.001821746409879,0.001843358191087,0.001558310835237,0.001100802884917,0.0006509213111528,0.0003157717098084,0.000123983663002,3.674797548785e-05,6.735734249321e-06,7.405627809855e-07,-4.453732255304e-07,-2.866811051647e-08,-1.308568358615e-08},
	},
	{
		.width = 3600,
		.type = IIR_LATTICE_LPF,
		.stages = 20,
		.coeffsK_lattice = (float32_t[]){0.0008323669549584,-0.01163446197871,0.07018258720016,-0.2347680856109,0.4786620886379,-0.6767505353761,0.7881845789344,-0.8479853307738,0.8834818637426,-0.9065652768402,0.9226394678694,-0.9338290617463,0.9435816389722,-0.9463482937602,0.9613915963606,-0.9408327766835,0.9849736452475,-0.9131645391658,0.9979470515637,-0.8918424160001},
		.coeffsV_ladder = (float32_t[]){4.568216327158e-06,2.340097870973e-05,7.963306862627e-05,0.0002174536557066,0.0005099430517795,0.001027970438322,0.001710812211934,0.00231495744546,0.002586109540111,0.002413836694185,0.001895892488139,0.00124865039618,0.0006859704529357,0.0003064955924354,0.0001074766766569,2.72605647433e-05,2.406017639036e-06,-7.839161150227e-08,-5.411042187237e-07,-3.331137065383e-08,-5.515870069784e-09},
	},
	{
		.width = 3800,
		.type = IIR_LATTICE_LPF,
		.stages = 20,
		.coeffsK_lattice = (float32_t[]){0.0005394425143916,-0.007987501876273,0.0515315750811,-0.1867774079565,0.4152768060904,-0.6275435434498,0.7566903149535,-0.8267379519148,0.8678128633022,-0.894260187505,0.9126532266121,-0.925211993067,0.9367881884505,-0.9386661505628,0.9581922650342,-0.9304874573032,0.984766573152,-0.8999406099508,0.9979272746332,-0.878977878568},
		.coeffsV_ladder = (float32_t[]){6.941152080043e-06,3.613472151957e-05,0.000123945860135,0.0003396693645975,0.0007986304775871,0.001629610357952,0.002782644914606,0.00387584674487,0.004444079739417,0.004243234538958,0.003395282408752,0.002267284765788,0.001253293212032,0.0005573334348825,0.0001891322718619,4.461432815247e-05,6.057791461435e-07,-9.045731494187e-07,-1.188836369966e-06,-7.467567857156e-08,-3.012356028449e-09},
	},
	{
		.width = 4000,
		.type = IIR_LATTICE_LPF,
		.stages = 22,
		.coeffsK_lattice = (float32_t[]){0.000149883237581,-0.002592226125158,0.01996128806124,-0.08904859134725,0.2507519585442,-0.4695547755594,0.647855467795,-0.7552393036642,0.8172197645926,-0.8559449157609,0.882219081763,-0.9006621915448,0.9152891987593,-0.9233745826806,0.9381068821709,-0.9281877041391,0.965099279258,-0.9075419402983,0.9898284597288,-0.8783413659765,0.9985400343292,-0.8645287887551},
		.coeffsV_ladder = (float32_t[]){5.392371464855e-06,2.963559305979e-05,0.0001056594281069,0.0002988372022476,0.0007237688157042,0.001548374788374,0.002892090006671,0.004543594472011,0.005926560175923,0.006471025251955,0.005965068716441,0.004647498929742,0.003048009473984,0.001657468369191,0.0007265977877194,0.0002429310218374,4.650466856233e-05,2.873458988149e-06,-6.242922553281e-06,-1.046782415286e-06,-2.821077107939e-07,-1.809614269327e-08,9.046539204767e-09},
	},
	{
		.width = 4500,
		.type = IIR_LATTICE_LPF,
		.stages = 23,
		.coeffsK_lattice = (float32_t[]){-2.825151639989e-05,0.0005783185673002,-0.005379556493131,0.02982490154536,-0.1083289055474,0.2675554938485,-0.4665832248836,0.6275771523252,-0.729020893216,0.7908819357967,-0.8310395645002,0.859517813631,-0.8788968076418,0.8976102887272,-0.901253530198,0.9295233175695,-0.8969204782877,0.9667129639431,-0.8652772842813,0.9910245195969,-0.8384095283888,0.9986004303347,-0.8282133650102},
		.coeffsV_ladder = (float32_t[]){7.868295878115e-06,4.696083583815e-05,0.000176671681595,0.000519110908875,0.001292109431223,0.002836221734483,0.005567629162323,0.009591719739744,0.01401889874896,0.01716274960472,0.01765457118632,0.01528968807189,0.01108406977067,0.006621173782753,0.003152390520303,0.001084057850291,0.0002232523652475,-5.402127811548e-05,-3.191600380643e-05,-1.691413260219e-05,-2.184682166602e-06,6.240248253236e-07,1.859095123049e-08,3.825521022599e-08},
	},
	{
		.width = 5000,
		.type = IIR_LATTICE_LPF,
		.stages = 24,
		.coeffsK_lattice = (float32_t[]){4.665674234346e-06,-0.0001112978957986,0.001225451331175,-0.008208980189268,0.03706081356081,-0.1177384170491,0.2679540215399,-0.449702024642,0.5996059730089,-0.6984866794983,0.7616706888487,-0.8033277352666,0.8352330440375,-0.8532412066012,0.8811786786297,-0.8707315109541,0.9264179345504,-0.8523524875502,0.9702287752501,-0.8155079465002,0.9918842149096,-0.7945766242507,0.9986326685087,-0.7882364323468},
		.coeffsV_ladder = (float32_t[]){1.081279342052e-05,6.964556192e-05,0.0002754980760299,0.0008384001300439,0.002137273153741,0.004765383302545,0.009516548810819,0.01710648547144,0.02708895405621,0.03659085741332,0.04150957742789,0.03940671926755,0.03109212307258,0.02000373434827,0.01000474096567,0.003518204910341,0.0003553186727642,-0.0002905436120686,-0.0003105389251052,-7.852637823632e-05,1.427120643025e-06,6.197046029937e-07,3.365594145625e-06,1.586768577359e-07,2.44625349175e-08},
	},
	{
		.width = 6000,
		.type = IIR_LATTICE_LPF,
		.stages = 30,
		.coeffsK_lattice = (float32_t[]){4.608905195725e-09,-1.419841314944e-07,2.702134792822e-06,-2.914457851129e-05,0.0002341350393748,-0.001373680301312,0.006357038150384,-0.02297724765107,0.0667009252322,-0.152838804529,0.2815933238067,-0.4179835359987,0.5389335249562,-0.6149509668525,0.691732754646,-0.7046525461296,0.7910430918875,-0.7290199592667,0.876110467994,-0.7116744212917,0.9392386956138,-0.6887280318162,0.9728713671692,-0.6806168646591,0.9886716434229,-0.6827363836965,0.9960736389332,-0.6892467620213,0.9992101851483,-0.6976084247717},
		.coeffsV_ladder = (float32_t[]){2.373136266481e-05,0.0001651578164621,0.0006838706678948,0.002134182279234,0.005487804116073,0.01216407804507,0.02385873313769,0.04208611296926,0.06743810748096,0.09865882952774,0.1314709524327,0.1568901182055,0.1616183255311,0.136970551162,0.08869505316168,0.03725712957295,-0.001393366765456,-0.01490320601222,-0.01463070556094,-0.006539738992406,-0.0001391074032673,0.0005608406824862,0.001147087036683,0.0002644195604981,2.392508980254e-05,4.180698310771e-06,-1.877357866966e-05,-1.418872656149e-06,-6.469612651676e-07,-3.262962982362e-08,1.835530464214e-08},
	},
	{
		.width = 7000,
		.type = IIR_LATTICE_LPF,
		.stages = 35,
		.coeffsK_lattice = (float32_t[]){1.090768266266e-09,1.72045342647e-08,1.417508714404e-07,8.870823548983e-07,3.617478780281e-06,1.899510360703e-05,2.916033234011e-05,0.0002955478981042,-0.0002311261605287,0.003712999298759,-0.006731358249632,0.03137263554663,-0.05521495106426,0.1516542231413,-0.204365460822,0.3919555393262,-0.3810380641421,0.6222739970012,-0.4667696861855,0.7803416536483,-0.4882673132297,0.8782218112969,-0.4979474779425,0.9333846792376,-0.5123909821348,0.9640682793913,-0.529847753345,0.9815504497283,-0.5477187985897,0.9914796487194,-0.5649918131701,0.9968352081855,-0.5813306301438,0.9993290125961,-0.5966415006436},
		.coeffsV_ladder = (float32_t[]){3.305165554595e-05,0.0002589960046344,0.00116106431689,0.003821024167686,0.01014352271153,0.02277629187929,0.04443946929284,0.07654399554453,0.1173808004948,0.1606694134999,0.195566074921,0.2089979572395,0.1902818406441,0.1363878752687,0.05655247622609,-0.02952917267654,-0.08769245215306,-0.09985727882046,-0.06372201594233,-0.005880764006755,0.01816685959135,0.03246870764468,0.01526900084044,0.001792335720593,-0.0006262980456565,-0.003838323586387,-0.001015995967576,-0.0002946523018468,-5.190888203327e-05,0.0001106820552527,1.265841558713e-05,8.905348537133e-06,7.737828146706e-07,-4.023022980251e-07,-6.7286522891e-09,-2.033625192474e-08},
	},
	{
		.width = 8000,
		.type = IIR_LATTICE_LPF,
		.stages = 39,
		.coeffsK_lattice = (float32_t[]){5.781832212923e-09,9.498045760972e-08,8.238655448705e-07,4.985417741596e-06,2.350527659515e-05,9.155530175941e-05,0.0003052332708247,0.0008921570225318,0.00232023407644,0.005452244629081,0.01156313059537,0.02276167648781,0.03970758869511,0.0686319882954,0.09389425215594,0.1597380198972,0.1426480810712,0.3156240711576,0.1074665434663,0.5373149855267,-0.02443475006666,0.7330098303186,-0.1515472459578,0.846959980363,-0.2357659177796,0.9097027411788,-0.2950858775437,0.9468463665197,-0.3412536933654,0.9696762609027,-0.379162157414,0.9837595838145,-0.4112923296943,0.9922417678169,-0.4391171093074,0.9970355157772,-0.4635821933727,0.9993562130186,-0.485348966001},
		.coeffsV_ladder = (float32_t[]){7.603836217099e-05,0.0006245560434052,0.002852480882878,0.009352750622485,0.02423911511359,0.05206813132263,0.09509142087177,0.1494851271694,0.2026930242884,0.2347769330425,0.2254715309676,0.1652824222695,0.06504672646529,-0.04320372565734,-0.1180579829256,-0.1298044573259,-0.07880184499134,0.004398492998567,0.06996857630219,0.09636999579717,0.06766502586118,0.009334795478323,-0.01879328388832,-0.04809251813382,-0.02557819969887,-0.007439986333039,-0.0004802078021126,0.008391787227758,0.002765944505972,0.0014372469204,0.0002993012411495,-0.0004224316939366,-7.032768985573e-05,-6.988203122197e-05,-8.686365522257e-06,3.895833800754e-06,1.735420561842e-07,5.707444941691e-07,1.926886609817e-08,8.994499871469e-10},
	},
	{
		.width = 9000,
		.type = IIR_LATTICE_LPF,
		.stages = 41,
		.coeffsK_lattice = (float32_t[]){1.345485349007e-08,2.389521171261e-07,2.203228037228e-06,1.396378348744e-05,6.803148109211e-05,0.0002703486206341,0.0009083849294174,0.002642193228705,0.006760090043425,0.0153815467982,0.0313553523696,0.05754728850407,0.09542794958997,0.1436438570118,0.1974692863579,0.2515002576911,0.2984398172954,0.3434432859449,0.3639504627247,0.4217449893128,0.3698259033427,0.5325776467969,0.2788228499926,0.6922522654556,0.1181431473393,0.8237737591745,-0.01682563863748,0.8983278549308,-0.1079170008682,0.9404745680836,-0.1743068171127,0.9659604644271,-0.2266354631983,0.9816787244295,-0.269711298313,0.9911969268858,-0.3061643981541,0.9966164557428,-0.3376315326373,0.9992608842547,-0.3652057832303},
		.coeffsV_ladder = (float32_t[]){0.0001159950580424,0.001030009903626,0.004923949586818,0.01646772655047,0.04251197897033,0.08879941261464,0.1535265801861,0.2210586114129,0.2621501554828,0.2456926941686,0.1593867051513,0.02670094630927,-0.09611149895473,-0.149214922352,-0.1097574637618,-0.01177379980515,0.07709532532773,0.1053325317097,0.06917935924162,0.003727140491137,-0.0470078541545,-0.06378931488732,-0.04382295542595,-0.007044101933644,0.01352654127346,0.03174315984188,0.01765966726565,0.004478047698445,-0.0004333967401422,-0.006950600778039,-0.00239772063299,-0.0009301901868248,-0.0001550518471736,0.0004913555718586,9.185678368695e-05,5.573703052281e-05,7.041861333323e-06,-8.625277176669e-06,-6.211940549693e-07,-6.426716638881e-07,-2.541692702997e-08,1.481363533602e-08},
	},
	{
		.width = 10000,
		.type = IIR_LATTICE_LPF,
		.stages = 41,
		.coeffsK_lattice = (float32_t[]){6.617891253681e-08,1.195162892304e-06,1.104897824683e-05,6.928219042821e-05,0.0003296238766739,0.001262429687736,0.004032667738053,0.01098979120895,0.02592631036951,0.05343973086615,0.09682854312901,0.1551363478849,0.2218773827095,0.2877356541324,0.34538039343,0.3919992418785,0.4282419141826,0.4564994389931,0.4779150022572,0.4976339831322,0.5056448075195,0.5352247587486,0.5014293572869,0.6045148249407,0.4246537659741,0.7302227950952,0.2696664974211,0.8492294274535,0.1227506497595,0.9176103691264,0.02043455991697,0.9546069384845,-0.05416873761734,0.9760504044094,-0.1129906095115,0.9886341703466,-0.1614066703465,0.9956676150421,-0.2023387620461,0.9990592221591,-0.2376132278784},
		.coeffsV_ladder = (float32_t[]){0.0002572526239649,0.002322936252084,0.01098714821339,0.03544628691169,0.08596126004483,0.1635693077672,0.2475401463512,0.29386560943,0.2568443505911,0.1276605115314,-0.0402822881304,-0.1531190906827,-0.1448233893344,-0.03725364163796,0.0758687382521,0.1131734486324,0.06783860815165,-0.007460727608986,-0.05662956890365,-0.05859236756623,-0.02784376249042,0.007545989854407,0.0264378768436,0.02586644002122,0.01249155159257,-0.003377782270604,-0.008287801566098,-0.01045857630493,-0.004379314309972,0.001218511662984,0.001123652175551,0.001996537546901,0.0005241652981312,-0.0001283969709398,-4.640901144182e-05,-0.000117204514579,-1.635067243866e-05,3.07134941796e-06,3.252121093256e-07,1.437883592709e-06,5.898773944042e-08,-6.148084452239e-09},
	},
	{
		.width = 15000,
		.type = IIR_LATTICE_LPF,
		.stages = 28,
		.coeffsK_lattice = (float32_t[]){3.461454524809e-05,0.0005784996540452,0.004565998218611,0.02242339459405,0.07586596572578,0.1851188339699,0.33647992143,0.4811583593639,0.5863630113354,0.6542728535753,0.6983349045986,0.7284968919611,0.7502555976776,0.76658039109,0.7791834400532,0.7891247888022,0.7971090492418,0.8035564816996,0.809120211424,0.8124397887025,0.8207290138146,0.807404196316,0.8566727443936,0.7396825472476,0.9407586961884,0.5812928265266,0.9907364419244,0.4447050405629},
		.coeffsV_ladder = (float32_t[]){0.00588341272121,0.04916361309029,0.1826266433116,0.3795196924432,0.4380735221467,0.1811599464755,-0.1745218140929,-0.205050290873,0.03185825479432,0.1318855608652,0.03967703944181,-0.0415068778093,-0.03491851690342,-0.0005191875097807,0.0121500912428,0.005976711734547,-0.001061120212398,-0.002397954562184,-0.0008571948801546,0.0002904285374825,0.0003968964792875,0.0001165654928172,-5.548741057737e-05,-5.684001604322e-05,-1.497041306209e-05,4.61880986613e-06,8.90631746886e-06,8.253127848495e-07,-7.854461646561e-07},
	},
	{
		.width = 20000,
		.type = IIR_LATTICE_LPF,
		.stages = 19,
		.coeffsK_lattice = (float32_t[]){0.01735020355945,0.1362870594067,0.4197338072673,0.6929331397604,0.8291083664039,0.8870701025321,0.9157343191544,0.9322038526622,0.9425980182355,0.9495725737726,0.9544573580749,0.9579841432567,0.9605715855816,0.9625100605069,0.9639184397367,0.9649560608753,0.9650321636578,0.9698317172651,0.9406088792782},
		.coeffsV_ladder = (float32_t[]){0.131720171422,0.5171798347275,0.5478986813276,-0.08089009252056,-0.2079020487255,0.03216700795792,0.03857630127459,-0.002962249513075,-0.004269488981663,3.049406586797e-06,0.0003389780595171,2.514030347811e-05,-2.046727786364e-05,-3.251259840908e-06,9.220357242157e-07,2.625922093102e-07,-2.533059273446e-08,-1.547707739746e-08,-2.638498308727e-10,7.266236223824e-10},
	},
};

static void calcBiquad(BIQUAD_TYPE type, uint32_t Fc, uint32_t Fs, float32_t Q, float32_t peakGain);
static IIR_LATTICE_FILTER* getIIRFilter(IIR_LATTICE_FILTER_TYPE type, uint16_t width);

void InitAudioFilters(void)
{
	arm_fir_init_f32(&FIR_RX_Hilbert_I, IQ_RX_HILBERT_TAPS, (float32_t *)&FIR_HILB_RX_I_coeffs, (float32_t *)&Fir_Rx_Hilbert_State_I[0], FPGA_AUDIO_BUFFER_HALF_SIZE);
	arm_fir_init_f32(&FIR_RX_Hilbert_Q, IQ_RX_HILBERT_TAPS, (float32_t *)&FIR_HILB_RX_Q_coeffs, (float32_t *)&Fir_Rx_Hilbert_State_Q[0], FPGA_AUDIO_BUFFER_HALF_SIZE);
	
	arm_fir_init_f32(&FIR_TX_Hilbert_I, IQ_TX_HILBERT_TAPS, (float32_t *)&FIR_HILB_TX_I_coeffs, (float32_t *)&Fir_Tx_Hilbert_State_I[0], FPGA_AUDIO_BUFFER_HALF_SIZE);
	arm_fir_init_f32(&FIR_TX_Hilbert_Q, IQ_TX_HILBERT_TAPS, (float32_t *)&FIR_HILB_TX_Q_coeffs, (float32_t *)&Fir_Tx_Hilbert_State_Q[0], FPGA_AUDIO_BUFFER_HALF_SIZE);

	InitNoiseReduction();
	InitNotchFilter();
}

void ReinitAudioFilters(void)
{
	//LPF
	if(CurrentVFO()->LPF_Filter_Width>0)
	{
		IIR_LATTICE_FILTER* lpf_filter = getIIRFilter(IIR_LATTICE_LPF, CurrentVFO()->LPF_Filter_Width);
		arm_iir_lattice_init_f32(&IIR_LPF_I, lpf_filter->stages, (float32_t *)lpf_filter->coeffsK_lattice, (float32_t *)lpf_filter->coeffsV_ladder, (float32_t *)&IIR_LPF_I_State[0], FPGA_AUDIO_BUFFER_HALF_SIZE);
		arm_iir_lattice_init_f32(&IIR_LPF_Q, lpf_filter->stages, (float32_t *)lpf_filter->coeffsK_lattice, (float32_t *)lpf_filter->coeffsV_ladder, (float32_t *)&IIR_LPF_Q_State[0], FPGA_AUDIO_BUFFER_HALF_SIZE);
	}
	
	//HPF
	if(CurrentVFO()->HPF_Filter_Width>0)
	{
		IIR_LATTICE_FILTER* hpf_filter = getIIRFilter(IIR_LATTICE_HPF, CurrentVFO()->HPF_Filter_Width);
		arm_iir_lattice_init_f32(&IIR_HPF_I, hpf_filter->stages, (float32_t *)hpf_filter->coeffsK_lattice, (float32_t *)hpf_filter->coeffsV_ladder, (float32_t *)&IIR_HPF_I_State[0], FPGA_AUDIO_BUFFER_HALF_SIZE);
		arm_iir_lattice_init_f32(&IIR_HPF_Q, hpf_filter->stages, (float32_t *)hpf_filter->coeffsK_lattice, (float32_t *)hpf_filter->coeffsV_ladder, (float32_t *)&IIR_HPF_Q_State[0], FPGA_AUDIO_BUFFER_HALF_SIZE);
	}
	
	//FM Squelch
	IIR_LATTICE_FILTER* fm_sql_hpf_filter;
	if(CurrentVFO()->LPF_Filter_Width>15000 || CurrentVFO()->LPF_Filter_Width==0)
		fm_sql_hpf_filter = getIIRFilter(IIR_LATTICE_HPF, 20000);
	else
		fm_sql_hpf_filter = getIIRFilter(IIR_LATTICE_HPF, 15000);
	arm_iir_lattice_init_f32(&IIR_Squelch_HPF, fm_sql_hpf_filter->stages, (float32_t *)fm_sql_hpf_filter->coeffsK_lattice, (float32_t *)fm_sql_hpf_filter->coeffsV_ladder, (float32_t *)&IIR_HPF_SQL_State[0], FPGA_AUDIO_BUFFER_HALF_SIZE);
}

void InitNotchFilter(void)
{
	NeedReinitNotch = false;
	calcBiquad(BIQUAD_notch, TRX.NotchFC, TRX_SAMPLERATE, 0.5f, 0);
}

static dc_filter_state_type dc_filter_state[6] =
	{
		{0, 0}, //0 RX I
		{0, 0}, //1 RX Q
		{0, 0}, //2 TX I
		{0, 0}, //3 TX Q
		{0, 0}, //4 FFT I
		{0, 0}, //5 FFT Q
};

void dc_filter(float32_t *Buffer, int16_t blockSize, uint8_t stateNum) //удаляет постоянную составлющую сигнала
{
	static const float32_t A1 = (1.0f - 0.00048828125f); // (1-2^(-11))

	for (uint16_t i = 0; i < blockSize; i++)
	{
		float32_t sampleIn = Buffer[i];
		float32_t sampleOut = 0;
		float32_t delta_x = sampleIn - dc_filter_state[stateNum].x_prev;
		float32_t a1_y_prev = A1 * dc_filter_state[stateNum].y_prev;
		sampleOut = delta_x + a1_y_prev;
		dc_filter_state[stateNum].x_prev = sampleIn;
		dc_filter_state[stateNum].y_prev = sampleOut;
		Buffer[i] = sampleOut;
	}
}

IIR_LATTICE_FILTER* getIIRFilter(IIR_LATTICE_FILTER_TYPE type, uint16_t width)
{
	for(uint16_t i=0; i<IIR_FILTERS_COUNT; i++)
		if(IIR_Lattice_Filters[i].type==type && IIR_Lattice_Filters[i].width==width)
			return (IIR_LATTICE_FILTER*)&IIR_Lattice_Filters[i];
	sendToDebug_strln("Wrong filter length");
	sendToDebug_uint16(type,false);
	sendToDebug_uint16(width,false);
	return NULL;
}

static void calcBiquad(BIQUAD_TYPE type, uint32_t Fc, uint32_t Fs, float32_t Q, float32_t peakGain)
{
	float32_t a0, a1, a2, b1, b2, norm;

	float32_t V = powf(10.0f, fabsf(peakGain) / 20.0f);
	float32_t K = tan(PI * Fc / Fs);
	switch (type)
	{
	case BIQUAD_onepolelp:
		b1 = exp(-2.0f * PI * (Fc / Fs));
		a0 = 1.0f - b1;
		b1 = -b1;
		a1 = a2 = b2 = 0.0f;
		break;

	case BIQUAD_onepolehp:
		b1 = -exp(-2.0f * PI * (0.5f - Fc / Fs));
		a0 = 1.0f + b1;
		b1 = -b1;
		a1 = a2 = b2 = 0.0f;
		break;

	case BIQUAD_lowpass:
		norm = 1.0f / (1.0f + K / Q + K * K);
		a0 = K * K * norm;
		a1 = 2.0f * a0;
		a2 = a0;
		b1 = 2.0f * (K * K - 1.0f) * norm;
		b2 = (1.0f - K / Q + K * K) * norm;
		break;

	case BIQUAD_highpass:
		norm = 1.0f / (1.0f + K / Q + K * K);
		a0 = 1.0f * norm;
		a1 = -2.0f * a0;
		a2 = a0;
		b1 = 2.0f * (K * K - 1.0f) * norm;
		b2 = (1.0f - K / Q + K * K) * norm;
		break;

	case BIQUAD_bandpass:
		norm = 1.0f / (1.0f + K / Q + K * K);
		a0 = K / Q * norm;
		a1 = 0.0f;
		a2 = -a0;
		b1 = 2.0f * (K * K - 1.0f) * norm;
		b2 = (1.0f - K / Q + K * K) * norm;
		break;

	case BIQUAD_notch:
		norm = 1.0f / (1.0f + K / Q + K * K);
		a0 = (1.0f + K * K) * norm;
		a1 = 2.0f * (K * K - 1.0f) * norm;
		a2 = a0;
		b1 = a1;
		b2 = (1.0f - K / Q + K * K) * norm;
		break;

	case BIQUAD_peak:
		if (peakGain >= 0.0f)
		{
			norm = 1.0f / (1.0f + 1.0f / Q * K + K * K);
			a0 = (1.0f + V / Q * K + K * K) * norm;
			a1 = 2.0f * (K * K - 1.0f) * norm;
			a2 = (1.0f - V / Q * K + K * K) * norm;
			b1 = a1;
			b2 = (1.0f - 1.0f / Q * K + K * K) * norm;
		}
		else
		{
			norm = 1.0f / (1.0f + V / Q * K + K * K);
			a0 = (1.0f + 1.0f / Q * K + K * K) * norm;
			a1 = 2.0f * (K * K - 1.0f) * norm;
			a2 = (1.0f - 1.0f / Q * K + K * K) * norm;
			b1 = a1;
			b2 = (1.0f - V / Q * K + K * K) * norm;
		}
		break;
	case BIQUAD_lowShelf:
		if (peakGain >= 0.0f)
		{
			norm = 1.0f / (1.0f + SQRT2 * K + K * K);
			a0 = (1.0f + sqrt(2.0f * V) * K + V * K * K) * norm;
			a1 = 2.0f * (V * K * K - 1.0f) * norm;
			a2 = (1.0f - sqrt(2.0f * V) * K + V * K * K) * norm;
			b1 = 2.0f * (K * K - 1.0f) * norm;
			b2 = (1.0f - SQRT2 * K + K * K) * norm;
		}
		else
		{
			norm = 1.0f / (1.0f + sqrt(2.0f * V) * K + V * K * K);
			a0 = (1.0f + SQRT2 * K + K * K) * norm;
			a1 = 2.0f * (K * K - 1.0f) * norm;
			a2 = (1.0f - SQRT2 * K + K * K) * norm;
			b1 = 2.0f * (V * K * K - 1.0f) * norm;
			b2 = (1.0f - sqrt(2.0f * V) * K + V * K * K) * norm;
		}
		break;
	case BIQUAD_highShelf:
		if (peakGain >= 0.0f)
		{
			norm = 1.0f / (1.0f + SQRT2 * K + K * K);
			a0 = (V + sqrt(2.0f * V) * K + K * K) * norm;
			a1 = 2.0f * (K * K - V) * norm;
			a2 = (V - sqrt(2.0f * V) * K + K * K) * norm;
			b1 = 2.0f * (K * K - 1.0f) * norm;
			b2 = (1.0f - SQRT2 * K + K * K) * norm;
		}
		else
		{
			norm = 1.0f / (V + sqrt(2.0f * V) * K + K * K);
			a0 = (1.0f + SQRT2 * K + K * K) * norm;
			a1 = 2.0f * (K * K - 1.0f) * norm;
			a2 = (1.0f - SQRT2 * K + K * K) * norm;
			b1 = 2.0f * (K * K - V) * norm;
			b2 = (V - sqrt(2.0f * V) * K + K * K) * norm;
		}
		break;
	}

	//save coefficients
	NOTCH_Coeffs[0] = a0;
	NOTCH_Coeffs[1] = a1;
	NOTCH_Coeffs[2] = a2;
	NOTCH_Coeffs[3] = -b1;
	NOTCH_Coeffs[4] = -b2;
}
