#include "audio_filters.h"
#include "stm32f4xx_hal.h"
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <math.h>
#include "arm_math.h"
#include "wm8731.h"

arm_fir_instance_f32    FIR_RX_Hilbert_I;
arm_fir_instance_f32    FIR_RX_Hilbert_Q;
arm_fir_instance_f32    FIR_RX_LPF;

//states
float32_t       Fir_Rx_Hilbert_State_I[FIR_RX_HILBERT_STATE_SIZE];
float32_t       Fir_Rx_Hilbert_State_Q[FIR_RX_HILBERT_STATE_SIZE];
float32_t		Fir_Rx_LPF_State[FPGA_AUDIO_BUFFER_SIZE+FIR_LPF_Taps];
float32_t		iir_rx_state[FIR_RX_LPF_STATE_SIZE];
float32_t		IIR_aa_state[FIR_RX_AA_STATE_SIZE];

// +0 degrees Hilbert narrow 3.6k
float32_t i_rx_3k6_coeffs[IQ_HILBERT_TAPS] = {-0.000181752008817777,-0.00019812444299558,-0.000173915580313638,-0.000106975730010085,-0.0000174463735378,0.000049667546759971,0.000032561004630231,-0.000127681493947272,-0.000459708207577463,-0.000935771201527816,-0.00145865712043841,-0.00187227346724911,-0.00200036401889901,-0.00170780689629204,-0.000967958368014592,0.000088289293095689,0.001166623215145986,0.001862531622450524,0.001771946721352388,0.000635741675713185,-0.00152451719575799,-0.00433057882661493,-0.00707443210838268,-0.00886614749018614,-0.00888315684570901,-0.00666207782636225,-0.0023460199801576,0.003204723474564544,0.008506335530971061,0.011765956147501436,0.011367103182967093,0.006413424630698947,-0.00282047953175066,-0.0146812039524101,-0.0262751422843746,-0.0339730971952901,-0.0341994964523126,-0.0243347165617545,-0.00350726050818481,0.026942155121425213,0.063476622132557281,0.100898465799951861,0.133312097666693830,0.155307720769003010,0.163093615613067344,0.155307720769004343,0.133312097666696161,0.100898465799954873,0.063476622132560459,0.026942155121428071,-0.00350726050818265,-0.0243347165617533,-0.0341994964523123,-0.0339730971952905,-0.0262751422843754,-0.0146812039524111,-0.00282047953175152,0.006413424630698421,0.011367103182966964,0.011765956147501661,0.008506335530971517,0.003204723474565072,-0.00234601998015715,-0.00666207782636198,-0.00888315684570896,-0.00886614749018627,-0.00707443210838294,-0.00433057882661522,-0.00152451719575822,0.000635741675713052,0.001771946721352369,0.001862531622450603,0.001166623215146122,0.000088289293095838,-0.00096795836801447,-0.00170780689629197,-0.002000364018899,-0.00187227346724914,-0.00145865712043846,-0.000935771201527874,-0.000459708207577509,-0.000127681493947298,0.000032561004630225,0.000049667546759980,-0.000017446373537785,-0.00010697573001007,-0.000173915580313629,-0.000198124442995578,-0.000181752};
// +90 degrees Hilbert narrow 3.6k
float32_t q_rx_3k6_coeffs[IQ_HILBERT_TAPS] = {-0.000294806871446761,-0.000430038513938049,-0.00057577635651954,-0.000701452460068679,-0.000773483568490036,-0.000770724776536896,-0.000701666832263429,-0.000616113554803381,-0.000603644067469941,-0.00077404001429163,-0.00122090559459946,-0.00197736129120186,-0.00297920572331694,-0.00405321865749724,-0.00494407320037525,-0.00538239440020133,-0.00518124403535075,-0.00433349474961163,-0.00307403519977391,-0.00187345276484406,-0.00134566807456456,-0.00207838789258401,-0.00442514292801338,-0.00832115293523963,-0.0131925136715957,-0.0180131059057811,-0.0215266256625295,-0.0226003081681251,-0.0206265730133377,-0.0158556828219807,-0.00954049290906044,-0.00380949445236171,-0.00125158785236759,-0.00427935828129978,-0.0144137579244869,-0.0316779221618311,-0.0542839354303643,-0.0787391229290012,-0.100398818306822,-0.114375118099481,-0.116607805332378,-0.104844680649768,-0.0792835060106304,-0.0426990455969243,-1.802423033856850E-15,0.042699045596920997,0.079283506010627697,0.104844680649766375,0.116607805332377912,0.114375118099481379,0.100398818306823789,0.078739122929003105,0.054283935430366234,0.031677922161832718,0.014413757924488018,0.004279358281300266,0.001251587852367549,0.003809494452361318,0.009540492909059896,0.015855682821980240,0.020626573013337410,0.022600308168125034,0.021526625662529674,0.018013105905781469,0.013192513671596058,0.008321152935239943,0.004425142928013570,0.002078387892584060,0.001345668074564481,0.001873452764843904,0.003074035199773733,0.004333494749611476,0.005181244035350659,0.005382394400201308,0.004944073200375284,0.004053218657497318,0.002979205723317022,0.001977361291201922,0.001220905594599500,0.000774040014291644,0.000603644067469934,0.000616113554803364,0.000701666832263413,0.000770724776536887,0.000773483568490036,0.000701452460068687,0.000575776356519553,0.000430038513938061,0.000294806871446770};
 

//FIR LPF 2.7k
float32_t FIR_2k7_LPF[FIR_LPF_Taps] = {-132.4349258372167810E-6,-219.6565051849731840E-6,-221.0954878572501340E-6,-112.7825639678642350E-6, 102.4575856101722450E-6, 389.2853249984518700E-6, 680.7047072996329010E-6, 886.5176124126478500E-6, 908.9190303575152260E-6, 663.1798212029935940E-6, 99.94394333471568360E-6,-775.2593942400565080E-6,-0.001889866979367635,-0.003103365535555945,-0.004219896473177527,-0.005014402752420468,-0.005269727863388856,-0.004819569738167059,-0.003590272808030926,-0.001633541409887721, 857.4275646318113790E-6, 0.003554075767444719, 0.006023490745282516, 0.007782972853164249, 0.008372642756768314, 0.007436788590800983, 0.004801979871354186, 538.9791894714875300E-6,-0.005003503223187542,-0.011202116188924751,-0.017203361876765948,-0.022007518376887823,-0.024584085267108431,-0.024005391839791387,-0.019581149012259533,-0.010975173068247874, 0.001713350295482858, 0.017917873275534617, 0.036629508851894865, 0.056479298752105583, 0.075870050881509124, 0.093142932024622954, 0.106758708615444731, 0.115470911994313030, 0.118468712970506387, 0.115470911994313030, 0.106758708615444731, 0.093142932024622954, 0.075870050881509124, 0.056479298752105583, 0.036629508851894865, 0.017917873275534617, 0.001713350295482858,-0.010975173068247874,-0.019581149012259533,-0.024005391839791387,-0.024584085267108431,-0.022007518376887823,-0.017203361876765948,-0.011202116188924751,-0.005003503223187542, 538.9791894714875300E-6, 0.004801979871354186, 0.007436788590800983, 0.008372642756768314, 0.007782972853164249, 0.006023490745282516, 0.003554075767444719, 857.4275646318113790E-6,-0.001633541409887721,-0.003590272808030926,-0.004819569738167059,-0.005269727863388856,-0.005014402752420468,-0.004219896473177527,-0.003103365535555945,-0.001889866979367635,-775.2593942400565080E-6, 99.94394333471568360E-6, 663.1798212029935940E-6, 908.9190303575152260E-6, 886.5176124126478500E-6, 680.7047072996329010E-6, 389.2853249984518700E-6, 102.4575856101722450E-6,-112.7825639678642350E-6,-221.0954878572501340E-6,-219.6565051849731840E-6,-132.4349258372167810E-6};

//LPF 2.7k SSB	
arm_iir_lattice_instance_f32 IIR_2k7_LPF =
{
    .numStages = 14,
    .pkCoeffs = (float*) (const float[]) { 0.0001352030231, -0.00130182039, 0.005726013798, -0.01496474817,  0.02503616177, -0.02589187399,  0.01126107108,  0.01126107108, -0.02589187399,  0.02503616177, -0.01496474817, 0.005726013798, -0.00130182039,0.0001352030231 },
    .pvCoeffs = (float*) (const float[]) { 1,   -12.19707775,    69.14491272,   -241.1901703,    577.4949341, -1002.180908,     1296.73999,   -1266.595215,    933.8630371,   -513.3150635, 204.4580383,   -55.88367844,    9.394873619,  -0.7337206602 }
};
//IIR BPF 120 - 2700Hz bandpass, 1410Hz center frequency
arm_iir_lattice_instance_f32 IIR_2k7_BPF =
{
    .numStages = 11,
    .pkCoeffs = (float*) (const float[]) { 9.876072227e-07,-2.875157406e-06,4.513433396e-06,-5.487821454e-06,4.838313544e-06, -3.148503765e-06,1.617615567e-06,-5.811978667e-07,1.591739931e-07,-2.494947715e-08, 1.486472057e-09 },
    .pvCoeffs = (float*) (const float[]) { 1,   -9.626163483,    41.94167328,     -108.92173,    186.7095947, -220.7347412,    182.2707825,   -103.8026886,    39.01845932,   -8.741547585, 0.8863812685 }
};

//IIR 5k Anti-aliasing Filter
arm_iir_lattice_instance_f32 IIR_aa_5k =
{
    .numStages = IIR_aa_5k_numStages,
    .pkCoeffs  = (float*) (const float[])
    {
        0.547564303565301,
        -0.874437851307620,
        0.929381964274064,
        -0.931756218288255,
        0.967791921156360,
        -0.855303237881406
    },

    .pvCoeffs = (float*) (const float[])
    {
        0.00321398613474079,
        0.0103775071609725,
        0.0204793631675465,
        0.0207411754628459,
        0.0142582715360116,
        0.00416771325172439,
        0.000586794199906653
    }
};

//IIR Biquad Filter (a notch, peak, and lowshelf filter)
arm_biquad_casd_df1_inst_f32 IIR_biquad =
{
	.numStages = 4,
	.pCoeffs = (float32_t *)(float32_t [])
	{
		1,0,0,0,0,  1,0,0,0,0,  1,0,0,0,0,  1,0,0,0,0
	}, // 4 x 5 = 20 coefficients
	.pState = (float32_t *)(float32_t [])
	{
		0,0,0,0,   0,0,0,0,   0,0,0,0,   0,0,0,0
	} // 4 x 4 = 16 state variables
};

